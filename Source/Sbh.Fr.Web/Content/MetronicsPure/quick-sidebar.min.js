//=================param global chat=================================
var parSender, parReceiver;
var parInterval;
//===================================================================

var QuickSidebar = function () {
    var i = function () {
        $(".dropdown-quick-sidebar-toggler a, .page-quick-sidebar-toggler, .quick-sidebar-toggler").click(function (i) {
            $("body").toggleClass("page-quick-sidebar-open")
        })
    },
        a = function () {
            var i = $(".page-quick-sidebar-wrapper"),
                a = i.find(".page-quick-sidebar-chat"),
                e = function () {
                    var e, t = i.find(".page-quick-sidebar-chat-users");
                    e = i.height() - i.find(".nav-tabs").outerHeight(!0), App.destroySlimScroll(t), t.attr("data-height", e), App.initSlimScroll(t);
                    var r = a.find(".page-quick-sidebar-chat-user-messages"),
                        s = e - a.find(".page-quick-sidebar-chat-user-form").outerHeight(!0);
                    s -= a.find(".page-quick-sidebar-nav").outerHeight(!0), App.destroySlimScroll(r), r.attr("data-height", s), App.initSlimScroll(r)
                };
            e(), App.addResizeHandler(e), i.find(".page-quick-sidebar-chat-users .media-list > .media").click(function () {
                a.addClass("page-quick-sidebar-content-item-shown");
                alert("hamka ganteng");
            }), i.find(".page-quick-sidebar-chat-user .page-quick-sidebar-back-to-list").click(function () {
                a.removeClass("page-quick-sidebar-content-item-shown")
            });
            var t = function (i) {
                i.preventDefault();
                var e = a.find(".page-quick-sidebar-chat-user-messages"),
                    t = a.find(".page-quick-sidebar-chat-user-form .form-control"),
                    r = t.val();
                if (0 !== r.length) {
                    var s = function (i, a, e, t, r) {
                        var s = "";
                        return s += '<div class="post ' + i + '">', s += '<img class="avatar" alt="" src="' + Layout.getLayoutImgPath() + t + '.jpg"/>', s += '<div class="message">', s += '<span class="arrow"></span>', s += '<a href="#" class="name">Bob Nilson</a>&nbsp;', s += '<span class="datetime">' + a + "</span>", s += '<span class="body">', s += r, s += "</span>", s += "</div>", s += "</div>"
                    },
                        n = new Date,
                        c = s("out", n.getHours() + ":" + n.getMinutes(), "Bob Nilson", "avatar3", r);
                    c = $(c), e.append(c), e.slimScroll({
                        scrollTo: "1000000px"
                    }), t.val(""), setTimeout(function () {
                        var i = new Date,
                            a = s("in", i.getHours() + ":" + i.getMinutes(), "Ella Wong", "avatar2", "HAMKA ipsum doloriam nibh...");
                        a = $(a), e.append(a), e.slimScroll({
                            scrollTo: "1000000px"
                        })
                    }, 3e3)
                }
            };
            a.find(".page-quick-sidebar-chat-user-form .btn").click(t), a.find(".page-quick-sidebar-chat-user-form .form-control").keypress(function (i) {
                if (13 == i.which) return t(i), !1
            })
        },
        e = function () {
            var i = $(".page-quick-sidebar-wrapper"),
                a = function () {
                    var a, e = i.find(".page-quick-sidebar-alerts-list");
                    a = i.height() - 80 - i.find(".nav-justified > .nav-tabs").outerHeight(), App.destroySlimScroll(e), e.attr("data-height", a), App.initSlimScroll(e)
                };
            a(), App.addResizeHandler(a)
        },
        t = function () {
            var i = $(".page-quick-sidebar-wrapper"),
                a = function () {
                    var a, e = i.find(".page-quick-sidebar-settings-list");
                    a = i.height() - 80 - i.find(".nav-justified > .nav-tabs").outerHeight(), App.destroySlimScroll(e), e.attr("data-height", a), App.initSlimScroll(e)
                };
            a(), App.addResizeHandler(a)
        };
    return {
        init: function () {
            i()
            //, a()
            //, e()
            //, t()
        }
    }
}();

App.isAngularJsApp() === !1 && jQuery(document).ready(function () {
    QuickSidebar.init()
});

function ShowChat(sender, receiver) {
    //show chat detail
    var wrap = $(".page-quick-sidebar-wrapper");
    var cht = wrap.find(".page-quick-sidebar-chat");
    cht.addClass("page-quick-sidebar-content-item-shown");


    //hide object person
    var obperson = $(".page-quick-sidebar-chat-users");
    obperson.addClass("hidden");

    //set param global chat
    parSender = sender;
    parReceiver = receiver;

    //syncronize every a second
    window.myInterval = setInterval(function () {
        //set data chatbox
        $.ajax({
            //url: 'http://localhost:52325/Chatting/GetListChatBox/',
            url: pathWeb + "/Chatting/GetListChatBox/",
            type: 'Post',
            data: { senderId: sender, receiverID: receiver },
            success: function (result) {
                console.log(result);
                var htmlChat = "";
                for (var i = 0; i < result.length; i++) {
                    if (result[i].SENDER_ID == sender) {
                        htmlChat = htmlChat + "<div class='post out'><img class='avatar' alt='' src='/Content/img/avatar4.jpg'><div class='message'><span class='arrow'></span><a href='#' class='name'>" + result[i].SENDER_NAME + "</a> &nbsp; &nbsp; &nbsp; <span class='datetime'>" + result[i].TIME + "</span><span class='body'>" + result[i].MESSAGE + "</span></div></div>"
                    } else {
                        htmlChat = htmlChat + "<div class='post in'><img class='avatar' alt='' src='/Content/img/avatar4.jpg'><div class='message'><span class='arrow'></span><a href='#' class='name'>" + result[i].SENDER_NAME + "</a> &nbsp; &nbsp; &nbsp; <span class='datetime'>" + result[i].TIME + "</span><span class='body'>" + result[i].MESSAGE + "</span></div></div>"
                    }
                }
                $("#htmlChat").html(htmlChat);
            }
        });
        SetFocusScroll();
    }, 3000);
    
}
 

function HideChat() {
    //show chat detail
    var wrap = $(".page-quick-sidebar-wrapper");
    var cht = wrap.find(".page-quick-sidebar-chat");
    cht.removeClass("page-quick-sidebar-content-item-shown")

    //hide object person
    var obperson = $(".page-quick-sidebar-chat-users");
    obperson.removeClass("hidden");

    //stop interval
    window.clearInterval(window.myInterval);
}

function CreateChatMessage() {
    var msg = $("#txtChatMessage").val();
    rs = $.xResponse(pathWeb + '/Chatting/CreateChatMessage/', { senderId: parSender, receiverId: parReceiver, message:  msg});
    if (IsSuccess()) {
        ShowChat(parSender, parReceiver);
        SetFocusScroll();
        $("#txtChatMessage").val("");
    } else {
        alertError(MessageText());
    }
}


function OnKeyPressChatMessage(event) {
    if (event.which == 13 || event.keyCode == 13) {
        CreateChatMessage();
    }
}

function SetFocusScroll(){
    var out = document.getElementById("htmlChat");
    $("#htmlChat").animate({
        scrollTop: out.scrollTop + 67
    })
}

